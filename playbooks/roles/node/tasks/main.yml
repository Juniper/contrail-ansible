---
- name: fail in case of invalid os_release
  fail: msg="os_release should be one of {{ valid_os_release }}"
  when: "os_release not in valid_os_release"

- name: Run the common task to create list
  include_role:
    name: common
    tasks_from: create_list_facts
    
# For nodes relying on a repo container host repository list is setup after installing
# docker-py to avoid trying to install docker-py via a container that is not up
# yet
- include: "{{ docker_py_pkg_install_method }}.yml"
  when:
    - docker_required == true
    - "'kubernetes-contrail-controllers' not in group_names"
    - "'kubernetes-contrail-analytics' not in group_names"

- include: "repo/{{ ansible_os_family }}.yml"
  tags: [repo]
  when:
    - "'contrail-repo' in groups"
    - "'kubernetes-contrail-controllers' not in group_names"
    - "'kubernetes-contrail-analytics' not in group_names"

- include: host.yml
  tags: [always]
  when:
    - "'contrail-repo' in groups"
    - "'kubernetes-contrail-controllers' not in group_names"
    - "'kubernetes-contrail-analytics' not in group_names"

- include: lb.yml
  tags: [container.lb, lb]
  when: "'contrail-lb' in group_names"

- include: controller.yml
  tags: [container.controller, controller]
  when: "'contrail-controllers' in group_names and not nested_mode"

- include: analyticsdb.yml
  tags: [container.analyicsdb, analyticsdb]
  when: "'contrail-analyticsdb' in group_names and not nested_mode"

- include: analytics.yml
  tags: [container.analytics, analytics]
  when: "'contrail-analytics' in group_names and not nested_mode"

- include: kube_manager_nested.yml
  when: nested_mode

- include: kube_manager_link_local.yml
  when: "nested_mode and 'kubernetes-contrail-controllers' in group_names"

- include: kube_manager.yml
  tags: [container.kube_manager, kube_manager]
  when: "'contrail-kubernetes' in group_names and cloud_orchestrator in ['kubernetes', 'openshift']"

- include: qos.yml
  when:
    - qos is defined or qos_niantic is defined
    - contrail_compute_mode == 'container'

- include: vgw_facts.yml
  when:
    - vgw is defined
    - contrail_compute_mode == 'container'

- include: "agent.yml"
  tags: [container.agent, agent]
  when: "'contrail-compute' in group_names and contrail_compute_mode == 'container' and not nested_mode"

- include: kubernetes_agent.yml
  tags: [container.agent, agent]
  when: "'contrail-compute' in group_names and (cloud_orchestrator in ['openshift','kubernetes'])"

# For kubernetes and openshift, agent will install cni file to the node
- include: kube_cni.yml
  tags: [container.kube_cni, kube_cni]
  when: "'contrail-compute' in group_names and cloud_orchestrator == 'mesos'"

- include: mesos_manager.yml
  tags: [container.mesos_manager, mesos_manager]
  when: "'contrail-compute' in group_names and cloud_orchestrator == 'mesos'"

- include: storage_ceph_controller.yml
  tags: [container.ceph_controller, ceph_controller]
  when: "'ceph-controller' in group_names"

# Support for vcenter plugin role
- include: vc_plugin.yml
  tags: [container.vc_plugin, vc_plugin]
  when: "'contrail-vc-plugin' in group_names"

