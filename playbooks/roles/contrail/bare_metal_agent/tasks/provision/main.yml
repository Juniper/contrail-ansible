---
- name: Wait till config api server answers
  uri:
    url: "{{ api_server_url }}"
    status_code: 200
  register: api_server_connect_status
  until: api_server_connect_status.status == 200
  retries: 180
  delay: 1

- name: Parse qos niantic configuration
  set_fact:
    priority_id_list: "{{ priority_id_list + [ item.get('priority_id') ] }}"
    priority_scheduling_list: "{{ priority_scheduling_list + [ item.get('scheduling') ] }}"
    priority_bandwidth_list: "{{ priority_bandwidth_list + [ item.get('bandwidth') ] }}"
  when: item
  with_items: "{{ priority_config_compute }}"

- name: Form qos niantic command line arguments
  set_fact:
    priority_id_config: "{{ '--priority_id ' + priority_id_list | join(' ')  if priority_id_list else '' }}"
    priority_scheduling_config: "{{ '--priority_scheduling ' + priority_scheduling_list | join(' ') if priority_scheduling_list else '' }}"
    priority_bandwidth_config: "{{ '--priority_bandwidth ' + priority_bandwidth_list | join(' ') if priority_bandwidth_list else '' }}"

- name: Parse qos configuration
  set_fact:
    qos_queue_id_list: "{{ qos_queue_id_list + [ item.get('hardware_q_id') ] }}"
    qos_logical_queue_list: "{{ qos_logical_queue_list  + [ item.get('logical_queue') | join(';') | regex_replace(' ','') | regex_replace(';',',') ] }}"
  with_items: "{{ qos_config_compute }}"
  when:
    - item
    - "'default' not in item.keys()"

- name: Parse default queue qos configuration
  set_fact:
    default_nic_queue: "{{ [item] }}"
    qos_queue_id_list: "{{ qos_queue_id_list + [ item.get('hardware_q_id') ] }}"
  with_items: "{{ qos_config_compute }}"
  when:
    - item
    - "'default' in item.keys()"

- name: Parse logical queue mapping for default queue
  set_fact:
    qos_logical_queue_list: "{{ qos_logical_queue_list  + [ item.get('logical_queue') | join(';') | regex_replace(' ','') | regex_replace(';',',') ] }}"
  with_items: "{{ default_nic_queue }}"
  when:
    - item
    - "'logical_queue' in item.keys()"

- name: Form qos command line arguments
  set_fact:
    default_hw_queue: "{{ '--default_hw_queue_qos' if default_nic_queue else ''}}"
    qos_queue_id_config: "{{ '--qos_queue_id ' + qos_queue_id_list | join(' ') if qos_queue_id_list else ''}}"
    qos_logical_queue_config: "{{ '--qos_logical_queue ' + qos_logical_queue_list | join(' ') if qos_logical_queue_list else ''}}"

- name: Run contrail-compute-setup script, logs at /var/log/contrail/contrail_vrouter_provisioning.log

  shell: "contrail-compute-setup --cfgm_ip {{ config_ip }} \
          --keystone_ip {{ keystone_ip }} \
          --self_ip {{ my_compute_ip }} {{ multi_intf_ip_config }} \
          {{ multi_intf_gw_config }} \
          --hypervisor {{ hypervisor }} \
          --keystone_auth_protocol {{ keystone_auth_protocol }} \
          --keystone_auth_port {{ keystone_admin_port }} \
          --keystone_admin_user {{ keystone_admin_user }} \
          --keystone_admin_password {{ keystone_admin_password }} \
          --keystone_admin_tenant_name {{ keystone_admin_tenant }} \
          --register \
          {{ qos_queue_id_config }} \
          {{ qos_logical_queue_config }} \
          {{ default_hw_queue }} \
          {{ priority_id_config }} \
          {{ priority_scheduling_config }} \
          {{ priority_bandwidth_config }} \
          {{ control_nodes_arg }} \
          {{ collectors_arg }} \
          {{ xmpp_auth_flag }} \
          {{ sandesh_ssl_flag }} \
          {{ introspect_ssl_flag }} \
          {{ dpdk_config }}"
